version: "3.9"

# Shared settings for all environments
x-bolt-common: &bolt-common
  image: ghcr.io/stackblitz-labs/bolt.diy:sha-3f6050b
  restart: unless-stopped

  # Let image run its own CMD (pnpm run dockerstart)
  # Do not override command unless you know why.
  # command: ["pnpm", "run", "dockerstart"]

  environment:
    # Core runtime
    NODE_ENV: "production"
    PORT: "5173"
    HOST: "0.0.0.0"
    RUNNING_IN_DOCKER: "true"

    # Node heap (8 GB) – you said Hostinger VPS is strong
    NODE_OPTIONS: "--max_old_space_size=8192"

    # Logging / debugging
    VITE_LOG_LEVEL: "${VITE_LOG_LEVEL:-debug}"

    # Context size – heavy by default, tune down if you see memory pressure
    DEFAULT_NUM_CTX: "${DEFAULT_NUM_CTX:-65536}"

    # AI Provider keys – Coolify injects real values
    OPENAI_API_KEY: "${OPENAI_API_KEY}"
    ANTHROPIC_API_KEY: "${ANTHROPIC_API_KEY}"
    GROQ_API_KEY: "${GROQ_API_KEY}"
    HuggingFace_API_KEY: "${HuggingFace_API_KEY}"
    GOOGLE_GENERATIVE_AI_API_KEY: "${GOOGLE_GENERATIVE_AI_API_KEY}"
    OPEN_ROUTER_API_KEY: "${OPEN_ROUTER_API_KEY}"
    XAI_API_KEY: "${XAI_API_KEY}"
    TOGETHER_API_KEY: "${TOGETHER_API_KEY}"
    TOGETHER_API_BASE_URL: "${TOGETHER_API_BASE_URL}"
    AWS_BEDROCK_CONFIG: "${AWS_BEDROCK_CONFIG}"
    OLLAMA_API_BASE_URL: "${OLLAMA_API_BASE_URL}"

  extra_hosts:
    - "host.docker.internal:host-gateway"

  # High memory profile for strong VPS
  deploy:
    resources:
      limits:
        memory: 8G
      reservations:
        memory: 4G

  logging:
    driver: "json-file"
    options:
      max-size: "10m"
      max-file: "5"

  read_only: false
  tmpfs:
    - /tmp
    - /var/run

  # Healthcheck for Coolify / Traefik
  healthcheck:
    test: ["CMD", "curl", "-f", "http://localhost:5173/"]
    interval: 20s
    timeout: 10s
    retries: 5
    start_period: 60s


services:
  # =========================
  # 1) PRODUCTION - app-prod
  # =========================
  app-prod:
    <<: *bolt-common
    container_name: bolt-diy-prod

    # Prod stays “pure” – just use the common environment as-is
    profiles: ["production"]

    # No host ports – Coolify/Traefik will route internally on 5173
    # If you want to expose directly (not recommended with Coolify),
    # uncomment:
    # ports:
    #   - "5173:5173"

    labels:
      - traefik.enable=true
      - traefik.http.routers.bolt-prod.entrypoints=websecure
      - traefik.http.routers.bolt-prod.rule=Host(`app-prod.thelux.app`)
      - traefik.http.routers.bolt-prod.tls=true
      - traefik.http.routers.bolt-prod.tls.certresolver=coolify
      - traefik.http.services.bolt-prod.loadbalancer.server.port=5173


  # ======================
  # 2) DEV - app-dev
  # ======================
  app-dev:
    <<: *bolt-common
    container_name: bolt-diy-dev
    profiles: ["development"]

    # Adjust env for "dev" environment (still using same image)
    environment:
      <<: *bolt-common.environment
      NODE_ENV: "development"
      VITE_LOG_LEVEL: "${VITE_LOG_LEVEL:-debug}"
      # Slightly lower context if you want lighter dev
      DEFAULT_NUM_CTX: "${DEFAULT_NUM_CTX_DEV:-32768}"

    labels:
      - traefik.enable=true
      - traefik.http.routers.bolt-dev.entrypoints=websecure
      - traefik.http.routers.bolt-dev.rule=Host(`app-dev.thelux.app`)
      - traefik.http.routers.bolt-dev.tls=true
      - traefik.http.routers.bolt-dev.tls.certresolver=coolify
      - traefik.http.services.bolt-dev.loadbalancer.server.port=5173


  # ===========================
  # 3) PREBUILD / STAGING - app-prebuild
  # ===========================
  app-prebuild:
    <<: *bolt-common
    container_name: bolt-diy-prebuild
    profiles: ["prebuilt"]

    # Can tweak this env differently if you want a staging config
    environment:
      <<: *bolt-common.environment
      VITE_LOG_LEVEL: "${VITE_LOG_LEVEL_PREBUILD:-info}"
      DEFAULT_NUM_CTX: "${DEFAULT_NUM_CTX_PREBUILD:-32768}"

    labels:
      - traefik.enable=true
      - traefik.http.routers.bolt-prebuild.entrypoints=websecure
      - traefik.http.routers.bolt-prebuild.rule=Host(`app-prebuild.thelux.app`)
      - traefik.http.routers.bolt-prebuild.tls=true
      - traefik.http.routers.bolt-prebuild.tls.certresolver=coolify
      - traefik.http.services.bolt-prebuild.loadbalancer.server.port=5173
